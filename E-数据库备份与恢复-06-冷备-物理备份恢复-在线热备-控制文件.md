<h1 style="text-align: center">冷备-物理备份-在线热备</h1>
<div style="text-align: center"><small>BooBooWei - 2019.12.01</small></div>
---

上一节课学习了物理备份-在线热备-数据文件；
今天学习的是在数据库正常提供服务的情况线下，备份控制文件。

---

[toc]

##  物理备份-在线热备-控制文件

### 核心命令SQL

1. 在线热备控制文件
  ```SQL
  alter database backup controlfile to '<backup control file path>';
  ```

2. 切换日志
  ```sql
  alter system switch logfile;
  ```

3. 恢复控制文件
  ```sql
  recover database using backup controlfile;
  ```
  
4. 重置redolog
  ```sql
  alter database open resetlogs;
  ```



### 实践01-在线热备控制文件

#### 控制文件备份的一般步骤

1. 在线热备控制文件`alter database backup controlfile to '<backup control file path>';`
2. 切换日志`alter system switch logfile;`
3. 查看备份的控制文件

#### 操作记录

```sql
SQL> alter database backup controlfile to '/home/oracle/hotbk/control01.ctl';

Database altered.

SQL> alter system switch logfile;

System altered.

SQL> /

System altered.

SQL> /

System altered.

SQL> /

System altered.

SQL> !ls -lh /home/oracle/hotbk/control01.ctl
-rw-r----- 1 oracle oinstall 9.4M 12月  1 19:42 /home/oracle/hotbk/control01.ctl

SQL> select count(*) from scott.t01;

  COUNT(*)
----------
	56
```



### 实践02-模拟控制文件损坏后的恢复

#### 控制文件恢复的一般步骤

1. 查看控制文件参数获取控制文件路径`show parameter control;`
2. 将备份的控制文件复制到控制文件路径`!cp <backup control file path> <control file path>`
3. 打开数据库到mount模式`alter database mount;`
4. 执行恢复控制文件的SQL命令`recover database using backup controlfile;`
5. 计算还需应用的redolog
6. 打开数据库到open模式`alter database open resetlog`

#### 操作记录

##### 模拟控制文件损坏

```sql
SQL> insert into scott.t01 select * from scott.t01;

56 rows created.

SQL> select count(*) from scott.t01;

  COUNT(*)
----------
       112

SQL> select * from v$controlfile;

STATUS
-------
NAME
--------------------------------------------------------------------------------
IS_ BLOCK_SIZE FILE_SIZE_BLKS
--- ---------- --------------

/alidata/oracle/oradata/testdb/control01.ctl
NO	 16384		  594


/alidata/oracle/flash_recovery_area/testdb/control02.ctl
NO	 16384		  594

STATUS
-------
NAME
--------------------------------------------------------------------------------
IS_ BLOCK_SIZE FILE_SIZE_BLKS
--- ---------- --------------


SQL> !rm -rf /alidata/oracle/oradata/testdb/control01.ctl

SQL> !rm -rf /alidata/oracle/flash_recovery_area/testdb/control02.ctl

SQL> startup force;
ORACLE instance started.

Total System Global Area 2137886720 bytes
Fixed Size		    2215064 bytes
Variable Size		 1392509800 bytes
Database Buffers	  738197504 bytes
Redo Buffers		    4964352 bytes
ORA-00205: error in identifying control file, check alert log for more info       
```

##### 恢复控制文件

```sql
SQL> show parameter control_file;

NAME				     TYPE	 VALUE
------------------------------------ ----------- ------------------------------
control_file_record_keep_time	     integer	 7
control_files			     string	 /alidata/oracle/oradata/testdb
						 /control01.ctl, /alidata/oracl
						 e/flash_recovery_area/testdb/c
						 ontrol02.ctl
SQL> !cp -v /home/oracle/hotbk/control01.ctl /alidata/oracle/oradata/testdb/control01.ctl
"/home/oracle/hotbk/control01.ctl" -> "/alidata/oracle/oradata/testdb/control01.ctl"

SQL> !cp -v /home/oracle/hotbk/control01.ctl /alidata/oracle/flash_recovery_area/testdb/control02.ctl
"/home/oracle/hotbk/control01.ctl" -> "/alidata/oracle/flash_recovery_area/testdb/control02.ctl"

SQL> alter database mount;

Database altered.

SQL> alter database open;
alter database open
*
ERROR at line 1:
ORA-01589: must use RESETLOGS or NORESETLOGS option for database open


SQL> recover database using backup controlfile;
ORA-00279: change 3460311 generated at 12/01/2019 21:45:17 needed for thread 1
ORA-00289: suggestion : /home/oracle/orc_booboo_dest1/1_120_1019996090.dbf
ORA-00280: change 3460311 for thread 1 is in sequence #120


Specify log: {<RET>=suggested | filename | AUTO | CANCEL}
auto
ORA-00279: change 3460407 generated at 12/01/2019 21:48:24 needed for thread 1
ORA-00289: suggestion : /home/oracle/orc_booboo_dest1/1_121_1019996090.dbf
ORA-00280: change 3460407 for thread 1 is in sequence #121
ORA-00278: log file '/home/oracle/orc_booboo_dest1/1_120_1019996090.dbf' no
longer needed for this recovery


ORA-00279: change 3460410 generated at 12/01/2019 21:48:25 needed for thread 1
ORA-00289: suggestion : /home/oracle/orc_booboo_dest1/1_122_1019996090.dbf
ORA-00280: change 3460410 for thread 1 is in sequence #122
ORA-00278: log file '/home/oracle/orc_booboo_dest1/1_121_1019996090.dbf' no
longer needed for this recovery


ORA-00279: change 3460413 generated at 12/01/2019 21:48:27 needed for thread 1
ORA-00289: suggestion : /home/oracle/orc_booboo_dest1/1_123_1019996090.dbf
ORA-00280: change 3460413 for thread 1 is in sequence #123
ORA-00278: log file '/home/oracle/orc_booboo_dest1/1_122_1019996090.dbf' no
longer needed for this recovery


ORA-00279: change 3460416 generated at 12/01/2019 21:48:28 needed for thread 1
ORA-00289: suggestion : /home/oracle/orc_booboo_dest1/1_124_1019996090.dbf
ORA-00280: change 3460416 for thread 1 is in sequence #124
ORA-00278: log file '/home/oracle/orc_booboo_dest1/1_123_1019996090.dbf' no
longer needed for this recovery


ORA-00279: change 3460419 generated at 12/01/2019 21:48:30 needed for thread 1
ORA-00289: suggestion : /home/oracle/orc_booboo_dest1/1_125_1019996090.dbf
ORA-00280: change 3460419 for thread 1 is in sequence #125
ORA-00278: log file '/home/oracle/orc_booboo_dest1/1_124_1019996090.dbf' no
longer needed for this recovery

ORA-00308: cannot open archived log
'/home/oracle/orc_booboo_dest1/1_125_1019996090.dbf'
ORA-27037: unable to obtain file status
Linux-x86_64 Error: 2: No such file or directory
Additional information: 3
```

##### `ORA-00308: cannot open archived log`

最后一个归档日志为`sequence #124`；Oracle需要`sequence #125`如何获取呢？

思路：

通过`select * from v$log;`查看备份的那一时刻，redolog日志组的状态

* 确定当前组为`GROUP#3`
* `SEQUENCE#120`

`125 - 120 = 5`

`5/3=1..2`

说明：备份控制文件后，redolog日志组轮询情况如下：

| GROUP     | SEQUENCE |
| --------- | -------- |
| `GROUP#3` | 120      |
| `GROUP#1` | 121      |
| `GROUP#2` | 122      |
| `GROUP#3` | 123      |
| `GROUP#1` | 124      |
| `GROUP#2` | 125      |

由此推算出`sequence #125`就是日志组`GROUP#2`。

```sql
SQL> select * from v$log;

    GROUP#    THREAD#  SEQUENCE#      BYTES  BLOCKSIZE	  MEMBERS ARC STATUS	       FIRST_CHANGE# FIRST_TIM NEXT_CHANGE# NEXT_TIME
---------- ---------- ---------- ---------- ---------- ---------- --- ---------------- ------------- --------- ------------ ---------
	 1	    1	     118   52428800	   512		1 YES INACTIVE		     3460106 01-DEC-19	    3460109 01-DEC-19
	 3	    1	     120   52428800	   512		1 NO  CURRENT		     3460112 01-DEC-19	 2.8147E+14
	 2	    1	     119   52428800	   512		1 YES INACTIVE		     3460109 01-DEC-19	    3460112 01-DEC-19
	 
SQL> column member format a50
SQL> select * from v$logfile;

    GROUP# STATUS  TYPE    MEMBER					      IS_
---------- ------- ------- -------------------------------------------------- ---
	 3	   ONLINE  /alidata/oracle/oradata/testdb/redo03.log	      NO
	 2	   ONLINE  /alidata/oracle/oradata/testdb/redo02.log	      NO
	 1	   ONLINE  /alidata/oracle/oradata/testdb/redo01.log	      NO	 
	 
SQL> select file#,checkpoint_change# from v$datafile_header;

     FILE# CHECKPOINT_CHANGE#
---------- ------------------
	 1	      3460419
	 2	      3460419
	 3	      3460419
	 4	      3460419
	 5	      3460419

SQL> select file#,checkpoint_change# from v$datafile;

     FILE# CHECKPOINT_CHANGE#
---------- ------------------
	 1	      3460274
	 2	      3460274
	 3	      3460274
	 4	      3460274
	 5	      3460274
```

* 数据文件显示的检查点为 `3460419`
* 控制文件显示的检查点为 `3460274`
* 可以看到 `数据文件 > 控制文件 `

> 因为控制文件是历史某一时刻的，而数据文件是当前的，所以检查点不一致。


```sql
SQL> recover database  using backup controlfile;
ORA-00279: change 3460419 generated at 12/01/2019 21:48:30 needed for thread 1
ORA-00289: suggestion : /home/oracle/orc_booboo_dest1/1_125_1019996090.dbf
ORA-00280: change 3460419 for thread 1 is in sequence #125


Specify log: {<RET>=suggested | filename | AUTO | CANCEL}
/alidata/oracle/oradata/testdb/redo02.log
Log applied.
Media recovery complete.

SQL> select file#,checkpoint_change# from v$datafile_header;

     FILE# CHECKPOINT_CHANGE#
---------- ------------------
	 1	      3460455
	 2	      3460455
	 3	      3460455
	 4	      3460455
	 5	      3460455
	 
SQL> select file#,checkpoint_change# from v$datafile;

     FILE# CHECKPOINT_CHANGE#
---------- ------------------
	 1	      3460455
	 2	      3460455
	 3	      3460455
	 4	      3460455
	 5	      3460455	 
```

* 数据文件显示的检查点为 `3460455`

* 控制文件显示的检查点为 `3460455`
* 可以看到 `数据文件 = 控制文件 `

```sql
SQL> alter database open resetlogs;

Database altered.

SQL> select count(*) from scott.t01;

  COUNT(*)
----------
	56
```

数据恢复到了控制文件备份的时间点。
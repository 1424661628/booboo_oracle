# 安装记录和问题处理

> 2020.01.11 BoobooWei

<!-- MDTOC maxdepth:6 firsth1:1 numbering:0 flatten:0 bullets:1 updateOnSave:1 -->

- [安装记录和问题处理](#安装记录和问题处理)   
   - [自动化脚本中重要打印内容](#自动化脚本中重要打印内容)   
      - [/etc/hosts的配置](#etchosts的配置)   
      - [RAC规划信息](#rac规划信息)   
   - [问题1:安装oracle软件时，无法识别节点](#问题1安装oracle软件时，无法识别节点)   
   - [问题2：dbca建库的过程中监听问题](#问题2：dbca建库的过程中监听问题)   
   - [问题3：创建数据库时提示不能验证ASMSNMP密码问题的解决(ORA-01017)](#问题3：创建数据库时提示不能验证asmsnmp密码问题的解决ora-01017)   

<!-- /MDTOC -->
## 自动化脚本中重要打印内容

### /etc/hosts的配置

```bash
# Public Network - (eth0)
192.168.14.150 rac1 rac1.example.com
192.168.14.151 rac2 rac2.example.com

# Private Interconnect - (eth1)
192.168.220.132 rac1-priv rac1-priv.example.com
192.168.220.133 rac2-priv rac2-priv.example.com

# Public Virtual IP
192.168.14.160 rac1-vip rac1-vip.example.com
192.168.14.161 rac2-vip rac2-vip.example.com

# scanIP
192.168.14.180 rac-cluster-scan
```

### RAC规划信息

```
节点信息
节点名称         数据库名称 处理器            内存               操作系统                              
rac1                 racdb      1          1906912kB  Red Hat Enterprise Linux Server release 6.7 (Santiago)                      
rac2                 racdb      1          1906912kB  Red Hat Enterprise Linux Server release 6.7 (Santiago)                      
资源规划-全局参数配置
节点名称              公共IP-网卡           虚拟IP-网卡           专用IP-网卡           SCAN-IP              SCAN名称           
rac1                 192.168.14.150-eth0  192.168.14.160       192.168.220.132-eth1 192.168.14.180       rac-cluster-scan     
rac2                 192.168.14.151-eth1  192.168.14.161       192.168.220.133-eth2                                           
Oracle 软件组件
软件组件                   操作系统用户             主组                         辅助组                 主目录                      Oracle基目录/Oracle主目录
Grid Infrastructure            grid                 oinstall             asmadmin、asmdba、asmoper    /home/grid           /alidata/app/grid,/u01/app/11.2.0/grid
Oracle RAC                     oracle               oinstall             dba、oper、asmdba            /home/oracle         /alidata/app/oracle,/alidata/app/oracle/product/11.2.0/dbhome_1
Oracle Grid 密码
Zyadmin123
```



## 问题1:安装oracle软件时，无法识别节点

解决方法：在文件中添加配置CRS="true"

```xml
vim /alidata/grid/app//oraInventory/ContentsXML/inventory.xml
cat: vim: No such file or directory
<?xml version="1.0" standalone="yes" ?>
<!-- Copyright (c) 1999, 2013, Oracle and/or its affiliates.
All rights reserved. -->
<!-- Do not modify the contents of this file by hand. -->
<INVENTORY>
<VERSION_INFO>
   <SAVED_WITH>11.2.0.4.0</SAVED_WITH>
   <MINIMUM_VER>2.1.0.6.0</MINIMUM_VER>
</VERSION_INFO>
<HOME_LIST>
<HOME NAME="Ora11g_gridinfrahome1" LOC="/alidata/grid/app/11.2.0/grid" TYPE="O" IDX="1" CRS="true">
   <NODE_LIST>
      <NODE NAME="rac1"/>
      <NODE NAME="rac2"/>
   </NODE_LIST>
</HOME>
<HOME NAME="OraDb11g_home1" LOC="/alidata/oracle/product/11.2.0/dbhome_1" TYPE="O" IDX="2">
   <NODE_LIST>
      <NODE NAME="rac1"/>
      <NODE NAME="rac2"/>
   </NODE_LIST>
</HOME>
</HOME_LIST>
<COMPOSITEHOME_LIST>
</COMPOSITEHOME_LIST>
</INVENTORY>
```

## 问题2：dbca建库的过程中监听问题

在安装oracle 11gR2 rac时，使用dbca建库的过程中提示需要创建监听，报错明细：
Default Listener "LISTENER" is not configured in Grid Infrantructure home.Use NetCA to configure Default Listener and return DBCA

解决方法：grid用户在没有监听的节点执行

```bash
srvctl add listener
srvctl start listener
```

解决明细：

因为oracle 11g rac在安装过程中会自动创建监听，无需手动创建，首先使用grid用户登录查看监听状态：

```bash
[grid@rac1 ~]$ crs_stat -t
Name           Type           Target    State     Host        
------------------------------------------------------------
ora.DATA.dg    ora....up.type ONLINE    ONLINE    rac1        
ora....N1.lsnr ora....er.type ONLINE    ONLINE    rac2        
ora.OCR.dg     ora....up.type ONLINE    ONLINE    rac1        
ora.asm        ora.asm.type   ONLINE    ONLINE    rac1        
ora.cvu        ora.cvu.type   ONLINE    ONLINE    rac2        
ora.gsd        ora.gsd.type   OFFLINE   OFFLINE               
ora....network ora....rk.type ONLINE    ONLINE    rac1        
ora.oc4j       ora.oc4j.type  ONLINE    ONLINE    rac2        
ora.ons        ora.ons.type   ONLINE    ONLINE    rac1        
ora....SM1.asm application    ONLINE    ONLINE    rac1        
ora.rac1.gsd   application    OFFLINE   OFFLINE               
ora.rac1.ons   application    ONLINE    ONLINE    rac1        
ora.rac1.vip   ora....t1.type ONLINE    ONLINE    rac1        
ora....SM2.asm application    ONLINE    ONLINE    rac2        
ora.rac2.gsd   application    OFFLINE   OFFLINE               
ora.rac2.ons   application    ONLINE    ONLINE    rac2        
ora.rac2.vip   ora....t1.type ONLINE    ONLINE    rac2        
ora....ry.acfs ora....fs.type ONLINE    ONLINE    rac1        
ora.scan1.vip  ora....ip.type ONLINE    ONLINE    rac2
```

rac1无监听，rac2有监听

```bash
[root@rac1 ~]# ps -ef|grep tns
root         13      2  0 07:45 ?        00:00:00 [netns]

[root@rac2 ~]# ps -ef|grep tns
root         13      2  0 04:29 ?        00:00:00 [netns]
grid      85795      1  0 07:49 ?        00:00:00 /alidata/grid/app/11.2.0/grid/bin/tnslsnr LISTENER_SCAN1 -inherit
```

rac1手动添加监听资源：
```bash
[grid@rac1 ~]$ srvctl status listener
PRCN-2044 : No listener exists
[grid@rac1 ~]$ srvctl add listener
[grid@rac1 ~]$ srvctl status listener
Listener LISTENER is enabled
Listener LISTENER is not running
[grid@rac1 ~]$ srvctl start listener
[grid@rac1 ~]$ srvctl status listener
Listener LISTENER is enabled
Listener LISTENER is running on node(s): rac2,rac1
```

再次查看
```bash
[grid@rac1 ~]$ crs_stat -t
Name           Type           Target    State     Host        
------------------------------------------------------------
ora.DATA.dg    ora....up.type ONLINE    ONLINE    rac1        
ora....ER.lsnr ora....er.type ONLINE    ONLINE    rac1        
ora....N1.lsnr ora....er.type ONLINE    ONLINE    rac2        
ora.OCR.dg     ora....up.type ONLINE    ONLINE    rac1        
ora.asm        ora.asm.type   ONLINE    ONLINE    rac1        
ora.cvu        ora.cvu.type   ONLINE    ONLINE    rac2        
ora.gsd        ora.gsd.type   OFFLINE   OFFLINE               
ora....network ora....rk.type ONLINE    ONLINE    rac1        
ora.oc4j       ora.oc4j.type  ONLINE    ONLINE    rac2        
ora.ons        ora.ons.type   ONLINE    ONLINE    rac1        
ora....SM1.asm application    ONLINE    ONLINE    rac1        
ora....C1.lsnr application    ONLINE    ONLINE    rac1        
ora.rac1.gsd   application    OFFLINE   OFFLINE               
ora.rac1.ons   application    ONLINE    ONLINE    rac1        
ora.rac1.vip   ora....t1.type ONLINE    ONLINE    rac1        
ora....SM2.asm application    ONLINE    ONLINE    rac2        
ora....C2.lsnr application    ONLINE    ONLINE    rac2        
ora.rac2.gsd   application    OFFLINE   OFFLINE               
ora.rac2.ons   application    ONLINE    ONLINE    rac2        
ora.rac2.vip   ora....t1.type ONLINE    ONLINE    rac2        
ora....ry.acfs ora....fs.type ONLINE    ONLINE    rac1        
ora.scan1.vip  ora....ip.type ONLINE    ONLINE    rac2
```

## 问题3：创建数据库时提示不能验证ASMSNMP密码问题的解决(ORA-01017)

解决方法：

```bash
orapwd file='orapw+ASM' entries=5 password=Zyadmin123
scp /alidata/grid/app/11.2.0/grid/dbs/orapw+ASM rac2:/alidata/grid/app/11.2.0/grid/dbs/orapw+ASM
sqlplus / as sysasm
SQL> create user asmsnmp identified by Zyadmin123;
SQL> grant sysdba to asmsnmp;
SQL> select * from v$pwfile_users;
```


1. 在各个节点的$ORACLE_HOME/dbs下删除orapw+ASM.ba口令文件

```bash
[grid@rac1 ~]$ cd /alidata/grid/app/11.2.0/grid/dbs
[grid@rac1 dbs]$ ll
total 12
-rw-rw----  1 grid oinstall 1143 Jan 11 07:49 ab_+ASM1.dat
-rw-rw----. 1 grid oinstall 1544 Jan 11 07:49 hc_+ASM1.dat
-rw-r--r--. 1 grid oinstall 2851 May 15  2009 init.ora

[grid@rac1 dbs]$ orapwd file='orapw+ASM' entries=5 password=Zyadmin123
[grid@rac1 dbs]$ ll
total 16
-rw-rw----  1 grid oinstall 1143 Jan 11 07:49 ab_+ASM1.dat
-rw-rw----. 1 grid oinstall 1544 Jan 11 07:49 hc_+ASM1.dat
-rw-r--r--. 1 grid oinstall 2851 May 15  2009 init.ora
-rw-r-----  1 grid oinstall 1536 Jan 11 11:54 orapw+ASM
```

2. 拷贝生成的口令到各个节点的当前实例中
```bash
[grid@rac1 dbs]$ scp /alidata/grid/app/11.2.0/grid/dbs/orapw+ASM rac2:/alidata/grid/app/11.2.0/grid/dbs/orapw+ASM
orapw+ASM
```

3. 增加asmsnmp用户到asm实例中并授予sysdba的权限
```bash
[grid@rac1 dbs]$ sqlplus / as sysasm

SQL*Plus: Release 11.2.0.4.0 Production on Sat Jan 11 12:01:42 2020

Copyright (c) 1982, 2013, Oracle.  All rights reserved.


Connected to:
Oracle Database 11g Enterprise Edition Release 11.2.0.4.0 - 64bit Production
With the Real Application Clusters and Automatic Storage Management options

SQL> create user asmsnmp identified by Zyadmin123;

User created.

SQL> grant dba to asmsnmp;
grant dba to asmsnmp
      *
ERROR at line 1:
ORA-00990: missing or invalid privilege


SQL> grant sysdba to asmsnmp;

Grant succeeded.

SQL> select * from v$pwfile_users;

USERNAME		       SYSDB SYSOP SYSAS
------------------------------ ----- ----- -----
SYS			       TRUE  TRUE  FALSE
ASMSNMP 		       TRUE  FALSE FALSE
```

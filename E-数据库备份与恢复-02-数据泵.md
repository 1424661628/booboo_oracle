# 02-数据泵

> 2019.11.10 BoobooWei

[toc]

## 数据泵官方介绍

[Oracle Data Pump](https://docs.oracle.com/en/database/oracle/oracle-database/19/sutil/oracle-data-pump.html#GUID-501A9908-BCC5-434C-8853-9A6096766B5A)

本部分讨论的主题包括数据泵导出，数据泵导入，旧模式，性能和数据泵API `DBMS_DATAPUMP`。

- [Oracle数据泵概述](https://docs.oracle.com/en/database/oracle/oracle-database/19/sutil/oracle-data-pump-overview.html#GUID-17FAE261-0972-4220-A2E4-44D479F519D4)
  Oracle数据泵技术可将数据和元数据从一个数据库高速移动到另一个数据库。
- [Oracle数据泵导出](https://docs.oracle.com/en/database/oracle/oracle-database/19/sutil/oracle-data-pump-export-utility.html#GUID-5F7380CE-A619-4042-8D13-1F7DDE429991)
  Oracle数据泵导出实用程序用于将数据和元数据卸载到一组操作系统文件中，这些文件称为转储文件集。
- [Oracle数据泵导入](https://docs.oracle.com/en/database/oracle/oracle-database/19/sutil/datapump-import-utility.html#GUID-D11E340E-14C6-43B8-AB09-6335F0C1F71B)
  使用Oracle数据泵导入，您可以将导出转储文件集加载到目标数据库中，或直接从源数据库中加载目标数据库，而无需插入文件。
- [Oracle数据泵旧模式](https://docs.oracle.com/en/database/oracle/oracle-database/19/sutil/oracle-data-pump-legacy-mode.html#GUID-B4A887AD-1E1D-4305-A6D8-DC16D3B28BA9)
  在Oracle数据泵旧模式下，您可以在Oracle数据泵导出和数据泵导入命令行上使用原始的导出和导入参数。
- [Oracle数据泵性能](https://docs.oracle.com/en/database/oracle/oracle-database/19/sutil/oracle-data-pump-performance-tips.html#GUID-B41F187E-3613-48F8-B47E-CD9BC918424B)
  了解Oracle数据泵导出和导入如何比原始的导出和导入更好，以及如何提高导出和导入操作的性能。
- [Oracle Data Pump API](https://docs.oracle.com/en/database/oracle/oracle-database/19/sutil/using-oracle_datapump-api.html#GUID-EAD7AE4B-778A-4369-9842-68E026409045)
  您可以使用Oracle Data Pump PL / SQL API自动执行数据移动操作`DBMS_DATAPUMP`。

## 我的理解

1. 与`exp`工具一样，`expdp`工具也属于逻辑备份，数据一致性为：备份开始的时间点；
2. 有三种使用方式：1）命令行；2）参数文件；3）交互式
3. 数据泵的导出模式：1）`full` 完全模式；2）`schema` 库模式；3）`tables` 表模式；4） `tablespace`表空间模式；5） `transport_tablespaces`可传输表空间模式
4. 从11g开始必须使用该工具做逻辑备份
5. 备份文件为二进制文件

### 实践1-创建逻辑目录用于存放逻辑备份

```bash
[oracle@oratest ~]$ mkdir /home/oracle/expbk
[oracle@oratest ~]$ sqlplus / as sysdba

SQL*Plus: Release 11.2.0.4.0 Production on Sun Nov 10 00:21:27 2019

Copyright (c) 1982, 2013, Oracle.  All rights reserved.


Connected to:
Oracle Database 11g Enterprise Edition Release 11.2.0.4.0 - 64bit Production
With the Partitioning, OLAP, Data Mining and Real Application Testing options

SQL> select *from dba_directories;

OWNER			       DIRECTORY_NAME
------------------------------ ------------------------------
DIRECTORY_PATH
--------------------------------------------------------------------------------
SYS			       ORACLE_OCM_CONFIG_DIR
/u01/app/oracle/product/11.2.0.4/ccr/hosts/oratest/state

SYS			       DATA_PUMP_DIR
/u01/app/oracle/product/11.2.0.4/rdbms/log/

SYS			       ORACLE_OCM_CONFIG_DIR2
/u01/app/oracle/product/11.2.0.4/ccr/state


SQL> column directory_path format a40
SQL> select *from dba_directories;

OWNER			       DIRECTORY_NAME
------------------------------ ------------------------------
DIRECTORY_PATH
----------------------------------------
SYS			       ORACLE_OCM_CONFIG_DIR
/u01/app/oracle/product/11.2.0.4/ccr/hos
ts/oratest/state

SYS			       DATA_PUMP_DIR
/u01/app/oracle/product/11.2.0.4/rdbms/l
og/

SYS			       ORACLE_OCM_CONFIG_DIR2

OWNER			       DIRECTORY_NAME
------------------------------ ------------------------------
DIRECTORY_PATH
----------------------------------------
/u01/app/oracle/product/11.2.0.4/ccr/sta
te


SQL> create or replace directory expbk as '/home/oracle/expbk';

Directory created.

SQL> grant read,write on directory expbk to scott;

Grant succeeded.

SQL> select *from dba_directories;

OWNER			       DIRECTORY_NAME
------------------------------ ------------------------------
DIRECTORY_PATH
----------------------------------------
SYS			       EXPBK
/home/oracle/expbk

SYS			       ORACLE_OCM_CONFIG_DIR
/u01/app/oracle/product/11.2.0.4/ccr/hos
ts/oratest/state

SYS			       DATA_PUMP_DIR
/u01/app/oracle/product/11.2.0.4/rdbms/l

OWNER			       DIRECTORY_NAME
------------------------------ ------------------------------
DIRECTORY_PATH
----------------------------------------
og/

SYS			       ORACLE_OCM_CONFIG_DIR2
/u01/app/oracle/product/11.2.0.4/ccr/sta
te
```

### 实践2-解决报错 ORA-39213  

执行`expdp`时报错如下：

```bash
ORA-39006: internal error
ORA-39213: Metadata processing is notavailable
```

执行`oerr ora <错误编号>`查看报错明细：

```bash
[oracle@oratest expbk]$ oerr ora 39213
39213, 00000, "Metadata processing is not available"
// *Cause:  The Data Pump could not use the Metadata API.  Typically,
//          this is caused by the XSL stylesheets not being set up properly.
// *Action: Connect AS SYSDBA and execute dbms_metadata_util.load_stylesheets
//          to reload the stylesheets.
```

可以看到解决方法为，使用`sysdba`角色的用户执行`execute  sys.dbms_metadata_util.load_stylesheets;`

### 实践3-全库备份导出

```bash
[oracle@oratest expbk]$ expdp userid=system/oracle job_name=full_job directory=expbk dumpfile=full.dump full=y logfile=full.log

Export: Release 11.2.0.4.0 - Production on Sun Nov 10 00:36:56 2019

Copyright (c) 1982, 2011, Oracle and/or its affiliates.  All rights reserved.

Connected to: Oracle Database 11g Enterprise Edition Release 11.2.0.4.0 - 64bit Production
With the Partitioning, OLAP, Data Mining and Real Application Testing options
Starting "SYSTEM"."FULL_JOB":  userid=system/******** job_name=full_job directory=expbk dumpfile=full.dump full=y logfile=full.log 
Estimate in progress using BLOCKS method...
Processing object type DATABASE_EXPORT/SCHEMA/TABLE/TABLE_DATA
Total estimation using BLOCKS method: 576 KB
Processing object type DATABASE_EXPORT/TABLESPACE
Processing object type DATABASE_EXPORT/PROFILE
Processing object type DATABASE_EXPORT/SYS_USER/USER
Processing object type DATABASE_EXPORT/SCHEMA/USER
Processing object type DATABASE_EXPORT/ROLE
Processing object type DATABASE_EXPORT/GRANT/SYSTEM_GRANT/PROC_SYSTEM_GRANT
Processing object type DATABASE_EXPORT/SCHEMA/GRANT/SYSTEM_GRANT
Processing object type DATABASE_EXPORT/SCHEMA/ROLE_GRANT
Processing object type DATABASE_EXPORT/SCHEMA/DEFAULT_ROLE
Processing object type DATABASE_EXPORT/RESOURCE_COST
Processing object type DATABASE_EXPORT/TRUSTED_DB_LINK
Processing object type DATABASE_EXPORT/SCHEMA/SEQUENCE/SEQUENCE
Processing object type DATABASE_EXPORT/DIRECTORY/DIRECTORY
Processing object type DATABASE_EXPORT/DIRECTORY/GRANT/OWNER_GRANT/OBJECT_GRANT
Processing object type DATABASE_EXPORT/CONTEXT
Processing object type DATABASE_EXPORT/SCHEMA/PUBLIC_SYNONYM/SYNONYM
Processing object type DATABASE_EXPORT/SCHEMA/SYNONYM
Processing object type DATABASE_EXPORT/SCHEMA/TYPE/TYPE_SPEC
Processing object type DATABASE_EXPORT/SYSTEM_PROCOBJACT/PRE_SYSTEM_ACTIONS/PROCACT_SYSTEM
Processing object type DATABASE_EXPORT/SYSTEM_PROCOBJACT/PROCOBJ
Processing object type DATABASE_EXPORT/SYSTEM_PROCOBJACT/POST_SYSTEM_ACTIONS/PROCACT_SYSTEM
Processing object type DATABASE_EXPORT/SCHEMA/PROCACT_SCHEMA
Processing object type DATABASE_EXPORT/SCHEMA/TABLE/TABLE
Processing object type DATABASE_EXPORT/SCHEMA/TABLE/PRE_TABLE_ACTION
Processing object type DATABASE_EXPORT/SCHEMA/TABLE/GRANT/OWNER_GRANT/OBJECT_GRANT
Processing object type DATABASE_EXPORT/SCHEMA/TABLE/COMMENT
Processing object type DATABASE_EXPORT/SCHEMA/PACKAGE/PACKAGE_SPEC
Processing object type DATABASE_EXPORT/SCHEMA/FUNCTION/FUNCTION
Processing object type DATABASE_EXPORT/SCHEMA/PROCEDURE/PROCEDURE
Processing object type DATABASE_EXPORT/SCHEMA/PACKAGE/COMPILE_PACKAGE/PACKAGE_SPEC/ALTER_PACKAGE_SPEC
Processing object type DATABASE_EXPORT/SCHEMA/FUNCTION/ALTER_FUNCTION
Processing object type DATABASE_EXPORT/SCHEMA/PROCEDURE/ALTER_PROCEDURE
Processing object type DATABASE_EXPORT/SCHEMA/TABLE/INDEX/INDEX
Processing object type DATABASE_EXPORT/SCHEMA/TABLE/CONSTRAINT/CONSTRAINT
Processing object type DATABASE_EXPORT/SCHEMA/TABLE/INDEX/STATISTICS/INDEX_STATISTICS
Processing object type DATABASE_EXPORT/SCHEMA/VIEW/VIEW
Processing object type DATABASE_EXPORT/SCHEMA/VIEW/GRANT/OWNER_GRANT/OBJECT_GRANT
Processing object type DATABASE_EXPORT/SCHEMA/VIEW/COMMENT
Processing object type DATABASE_EXPORT/SCHEMA/PACKAGE_BODIES/PACKAGE/PACKAGE_BODY
Processing object type DATABASE_EXPORT/SCHEMA/TABLE/CONSTRAINT/REF_CONSTRAINT
Processing object type DATABASE_EXPORT/SCHEMA/TABLE/STATISTICS/TABLE_STATISTICS
Processing object type DATABASE_EXPORT/SCHEMA/TABLE/POST_TABLE_ACTION
Processing object type DATABASE_EXPORT/SCHEMA/TABLE/TRIGGER
Processing object type DATABASE_EXPORT/SCHEMA/POST_SCHEMA/PROCACT_SCHEMA
Processing object type DATABASE_EXPORT/AUDIT
. . exported "SCOTT"."DEPT"                              5.929 KB       4 rows
. . exported "SCOTT"."EMP"                               8.562 KB      14 rows
. . exported "SCOTT"."SALGRADE"                          5.859 KB       5 rows
. . exported "SCOTT"."T02"                               5.421 KB       1 rows
. . exported "SYSTEM"."REPCAT$_AUDIT_ATTRIBUTE"          6.328 KB       2 rows
. . exported "SYSTEM"."REPCAT$_OBJECT_TYPES"             6.882 KB      28 rows
. . exported "SYSTEM"."REPCAT$_RESOLUTION_METHOD"        5.835 KB      19 rows
. . exported "SYSTEM"."REPCAT$_TEMPLATE_STATUS"          5.484 KB       3 rows
. . exported "SYSTEM"."REPCAT$_TEMPLATE_TYPES"           6.289 KB       2 rows
. . exported "OUTLN"."OL$"                                   0 KB       0 rows
. . exported "OUTLN"."OL$HINTS"                              0 KB       0 rows
. . exported "OUTLN"."OL$NODES"                              0 KB       0 rows
. . exported "SCOTT"."BONUS"                                 0 KB       0 rows
. . exported "SYSTEM"."DEF$_AQCALL"                          0 KB       0 rows
. . exported "SYSTEM"."DEF$_AQERROR"                         0 KB       0 rows
. . exported "SYSTEM"."DEF$_CALLDEST"                        0 KB       0 rows
. . exported "SYSTEM"."DEF$_DEFAULTDEST"                     0 KB       0 rows
. . exported "SYSTEM"."DEF$_DESTINATION"                     0 KB       0 rows
. . exported "SYSTEM"."DEF$_ERROR"                           0 KB       0 rows
. . exported "SYSTEM"."DEF$_LOB"                             0 KB       0 rows
. . exported "SYSTEM"."DEF$_ORIGIN"                          0 KB       0 rows
. . exported "SYSTEM"."DEF$_PROPAGATOR"                      0 KB       0 rows
. . exported "SYSTEM"."DEF$_PUSHED_TRANSACTIONS"             0 KB       0 rows
. . exported "SYSTEM"."REPCAT$_AUDIT_COLUMN"                 0 KB       0 rows
. . exported "SYSTEM"."REPCAT$_COLUMN_GROUP"                 0 KB       0 rows
. . exported "SYSTEM"."REPCAT$_CONFLICT"                     0 KB       0 rows
. . exported "SYSTEM"."REPCAT$_DDL"                          0 KB       0 rows
. . exported "SYSTEM"."REPCAT$_EXCEPTIONS"                   0 KB       0 rows
. . exported "SYSTEM"."REPCAT$_EXTENSION"                    0 KB       0 rows
. . exported "SYSTEM"."REPCAT$_FLAVORS"                      0 KB       0 rows
. . exported "SYSTEM"."REPCAT$_FLAVOR_OBJECTS"               0 KB       0 rows
. . exported "SYSTEM"."REPCAT$_GENERATED"                    0 KB       0 rows
. . exported "SYSTEM"."REPCAT$_GROUPED_COLUMN"               0 KB       0 rows
. . exported "SYSTEM"."REPCAT$_INSTANTIATION_DDL"            0 KB       0 rows
. . exported "SYSTEM"."REPCAT$_KEY_COLUMNS"                  0 KB       0 rows
. . exported "SYSTEM"."REPCAT$_OBJECT_PARMS"                 0 KB       0 rows
. . exported "SYSTEM"."REPCAT$_PARAMETER_COLUMN"             0 KB       0 rows
. . exported "SYSTEM"."REPCAT$_PRIORITY"                     0 KB       0 rows
. . exported "SYSTEM"."REPCAT$_PRIORITY_GROUP"               0 KB       0 rows
. . exported "SYSTEM"."REPCAT$_REFRESH_TEMPLATES"            0 KB       0 rows
. . exported "SYSTEM"."REPCAT$_REPCAT"                       0 KB       0 rows
. . exported "SYSTEM"."REPCAT$_REPCATLOG"                    0 KB       0 rows
. . exported "SYSTEM"."REPCAT$_REPCOLUMN"                    0 KB       0 rows
. . exported "SYSTEM"."REPCAT$_REPGROUP_PRIVS"               0 KB       0 rows
. . exported "SYSTEM"."REPCAT$_REPOBJECT"                    0 KB       0 rows
. . exported "SYSTEM"."REPCAT$_REPPROP"                      0 KB       0 rows
. . exported "SYSTEM"."REPCAT$_REPSCHEMA"                    0 KB       0 rows
. . exported "SYSTEM"."REPCAT$_RESOLUTION"                   0 KB       0 rows
. . exported "SYSTEM"."REPCAT$_RESOLUTION_STATISTICS"        0 KB       0 rows
. . exported "SYSTEM"."REPCAT$_RESOL_STATS_CONTROL"          0 KB       0 rows
. . exported "SYSTEM"."REPCAT$_RUNTIME_PARMS"                0 KB       0 rows
. . exported "SYSTEM"."REPCAT$_SITES_NEW"                    0 KB       0 rows
. . exported "SYSTEM"."REPCAT$_SITE_OBJECTS"                 0 KB       0 rows
. . exported "SYSTEM"."REPCAT$_SNAPGROUP"                    0 KB       0 rows
. . exported "SYSTEM"."REPCAT$_TEMPLATE_OBJECTS"             0 KB       0 rows
. . exported "SYSTEM"."REPCAT$_TEMPLATE_PARMS"               0 KB       0 rows
. . exported "SYSTEM"."REPCAT$_TEMPLATE_REFGROUPS"           0 KB       0 rows
. . exported "SYSTEM"."REPCAT$_TEMPLATE_SITES"               0 KB       0 rows
. . exported "SYSTEM"."REPCAT$_TEMPLATE_TARGETS"             0 KB       0 rows
. . exported "SYSTEM"."REPCAT$_USER_AUTHORIZATIONS"          0 KB       0 rows
. . exported "SYSTEM"."REPCAT$_USER_PARM_VALUES"             0 KB       0 rows
. . exported "SYSTEM"."SQLPLUS_PRODUCT_PROFILE"              0 KB       0 rows
Master table "SYSTEM"."FULL_JOB" successfully loaded/unloaded
******************************************************************************
Dump file set for SYSTEM.FULL_JOB is:
  /home/oracle/expbk/full.dump
Job "SYSTEM"."FULL_JOB" successfully completed at Sun Nov 10 00:37:27 2019 elapsed 0 00:00:31

[oracle@oratest expbk]$ ll -h
total 2.7M
-rw-r----- 1 oracle oinstall 2.7M Nov 10 00:37 full.dump
-rw-r--r-- 1 oracle oinstall 8.6K Nov 10 00:37 full.log
[oracle@oratest expbk]$ file full.dump
full.dump: DBase 3 data file (1728087684 records)
[oracle@oratest expbk]$ strings full.dump | head -n 20
"SYSTEM"."FULL_JOB"
x86_64/Linux 2.4.xx
BOOBOO
ZHS16GBK
11.02.00.04.00
001:001:000001:000001
HDR>T<?
1B"#
ejVW
4DDE
]uW\[
JVhv
L2k[
Q)hZ
E)H'
$DD@D
UUUUUUUUUUV`
.0](
HF((0
&`wrA
```



## 老师笔记

```
数据泵：oracle 10g 之后的版本可用，只有在服务端可用,使用PL/sql查询数据写备份文件

1.创建逻辑目录，使用逻辑目录保存数据泵的备份文件
conn / as sysdba
select * from dba_directories;
create or replace directory expbk as '/home/oracle/expbk';
授予scott读写逻辑目录的权限
grant read,write on directory expbk to scott;

expdp userid=scott/tiger JOB_NAME=exp_ob1 tables=ob1 directory=expbk dumpfile=expob1.dmp logfile=expob1.log content=METADATA_ONLY

expdp userid=scott/tiger JOB_NAME=exp_ob1 tables=ob1 directory=expbk dumpfile=expob1.dmp logfile=expob1_data.log content=DATA_ONLY

expdp userid=scott/tiger JOB_NAME=exp_ob1 tables=ob1 directory=expbk dumpfile=expob1.dmp logfile=expob1.log content=all

可以在导出多张表时带有限制条件
expdp userid=scott/tiger job_name=test_job directory=expbk tables=dept,emp query=dept:"where deptno<>40",emp:"where deptno=10" dumpfile=test.dmp logfile=test.log

导出用户模式
expdp userid=scott/tiger job_name=scott_job directory=expbk dumpfile=scott.dmp parallel=8 logfile=scott.log

导出表空间模式：
expdp userid=system/uplooking job_name=tbs010_job directory=expbk dumpfile=tbs010.dmp tablespaces=tbs010 parallel=8 logfile=tbs010log

导出全库模式：
expdp userid=system/uplooking job_name=full_job directory=expbk dumpfile=full.dmp full=y logfile=full.log

impdp userid=scott/tiger directory=expbk dumpfile=expob1.dmp

expdp userid=scott/tiger job_name=test_job directory=expbk include=view dumpfile=view.dmp

expdp userid=scott/tiger job_name=test_job directory=expbk include=table:"like 'E%'" dumpfile=e.dmp 

expdp userid=scott/tiger job_name=pemp_job directory=expbk dumpfile=pemp.dmp include=table:"in (select table_name||':'||partition_name from user_tab_partitions where table_name='P_EMP' and partition_name like 'P1\%')" logfile=pemp.log

expdp userid=scott/tiger job_name=test_job directory=expbk exclude=table:"like 'E%'" dumpfile=expdata.dmp

```

